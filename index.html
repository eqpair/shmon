<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>Position Report</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: right;
        }

        th {
            background-color: #f2f2f2;
        }

        td:first-child,
        th:first-child {
            text-align: left;
        }

        .negative {
            color: red;
        }

        .positive {
            color: blue;
        }
    </style>
</head>

<body>
    <h2>보유 포지션 현황</h2>
    <div id="last-update"></div>
    <table id="report">
        <thead>
            <tr>
                <th>종목</th>
                <th>수량</th>
                <th>평균단가</th>
                <th>매입금액</th> <!-- 새로 추가 -->
                <th>현재가</th>
                <th>평가금액</th>
                <th>손익</th>
                <th>손익률</th>
            </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
            <tr>
                <th colspan="5">합계</th>
                <th id="total-mv"></th>
                <th id="total-pnl"></th>
                <th id="total-pnl-ratio"></th>
            </tr>
        </tfoot>
    </table>

    <script>
        async function loadData() {
            const res = await fetch("live.json?_=" + Date.now());
            const data = await res.json();

            document.getElementById("last-update").innerText = "업데이트 시각: " + data.as_of;

            const tbody = document.querySelector("#report tbody");
            tbody.innerHTML = "";

            data.positions.forEach(p => {
                const tr = document.createElement("tr");
                const cost = (p.avg_price * p.qty).toFixed(0); // 매입금액 계산
                tr.innerHTML = `
          <td>${p.name}</td>
          <td>${p.qty.toLocaleString()}</td>
          <td>${p.avg_price.toLocaleString()}</td>
          <td>${Number(cost).toLocaleString()}</td>
          <td>${p.last_price.toLocaleString()}</td>
          <td>${p.mv.toLocaleString()}</td>
          <td class="${p.pnl >= 0 ? 'positive' : 'negative'}">${p.pnl.toFixed(0).toLocaleString()}</td>
          <td class="${p.pnl_ratio >= 0 ? 'positive' : 'negative'}">${(p.pnl_ratio * 100).toFixed(2)}%</td>
        `;
                tbody.appendChild(tr);
            });

            document.getElementById("total-mv").innerText = data.total_exposure.toLocaleString();
            document.getElementById("total-pnl").innerText = data.total_pnl.toFixed(0).toLocaleString();
            document.getElementById("total-pnl-ratio").innerText = (data.total_pnl_ratio * 100).toFixed(2) + "%";
            document.getElementById("total-pnl").className = data.total_pnl >= 0 ? "positive" : "negative";
            document.getElementById("total-pnl-ratio").className = data.total_pnl_ratio >= 0 ? "positive" : "negative";
        }

        loadData();
        setInterval(loadData, 30000); // 30초마다 갱신
    </script>
</body>

</html>